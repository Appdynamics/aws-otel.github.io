- [Before You Begin](#before-you-begin)
  - [AppDynamics](#appdynamics)
  - [AWS](#aws)
  - [OpenTelemetry Compatibility](#opentelemetry-compatibility)
    - [SaaS Controller version >=21.1.0](#saas-controller-version-2110)
    - [Active AppDynamics Pro Edition](#active-appdynamics-pro-edition)
  - [AppDynamics Credentials](#appdynamics-credentials)
    - [Permissions](#permissions)
- [Configure the AWS OpenTelemetry Collector YAML File](#configure-the-aws-opentelemetry-collector-yaml-file)
  - [Install the AWS Otel Collector](#install-the-aws-otel-collector)
  - [Configure Your Applications to Send Service Resource Attributes](#configure-your-applications-to-send-service-resource-attributes)
  - [Configure AWS OTel Collector for AppDynamics](#configure-aws-otel-collector-for-appdynamics)
    - [Processors](#processors)
      - [Resource Processor](#resource-processor)
      - [Batch Processor](#batch-processor)
      - [Receivers](#receivers)
      - [Exporters](#exporters)
      - [Services](#services)
      - [AppDynamics Configuration File Example](#appdynamics-configuration-file-example)
  - [Resources Attributes Description](#resources-attributes-description)
- [Verify Configuration](#verify-configuration)
- [Visualize Your OpenTelemetry Data](#visualize-your-opentelemetry-data)
- [Troubleshooting](#troubleshooting)

This document is intended to provide information specifically for using AWS Distro for OpenTelemetry in conjunction with AppDynamics. AWS Distro for OpenTelemetry is managed by AWS and is a separate product from AppDynamics solutions.

- For questions related to AWS Distro for OpenTelemetry, see [AWS OpenTelemetry Documentation](https://aws-otel.github.io/docs/introduction).
- For questions related to OpenTelemetry, see [OpenTelemetry Documentation](https://opentelemetry.io/docs/).

OpenTelemetry is a single, standardized vendor-agnostic solution used to generate, collect, and export telemetry data. Telemetry data consists of traces, metrics, and logs. OpenTelemetry uses a set of APIs and SDKs to function as a pipeline to ingest and distribute data.

This pipeline contains three components:

- Receivers: set data into the pipeline
- Processors: convert the data into chosen formats
- Exporters: send the converted data to the desired locations

![AppDTracingAWS]( assets/img/appd-otel-aws-distro.png)

AppDynamics provides an OpenTelemetry Protocol compliant backend to ingest telemetry data generated from applications monitored using [OpenTelemetry](https://github.com/open-telemetry/opentelemetry-specification/blob/master/specification/trace/api.md) components. The ingested data is processed by the AppDynamics backend to provide observability and diagnostic capabilities in your application and cloud environments. This page describes how to configure the [AWS OTel Collector](https://github.com/aws-observability/aws-otel-collector) to send OpenTelemetry trace data to the AppDynamics backend.

## Before You Begin

Review these prerequisites:

### AppDynamics

Confirm that you have access to a compatible Controller. See [Agent and Controller Compatibility](https://docs.appdynamics.com/display/PRO45/Agent+and+Controller+Compatibility).

**Note**: AppDynamics OpenTelemetry is not available for on-premises Controllers at this time.

### AWS

- Ensure that you have AWS OpenTelemetry Collector downloaded and installed on your deployment. See [Getting Started with the AWS Distro for OpenTelemetry Collector](https://aws-otel.github.io/docs/getting-started/collector).
- Verify that the AWS OpenTelemetry Collector has connectivity to the desired AppDynamics Controller where your OTel Collector reports data.

### OpenTelemetry Compatibility

- To use AppDynamics OpenTelemetry, you need a SaaS Controller version >=21.1.0, and an active AppDynamics Pro edition license.
- To enable Open Telemetry on Controllers < 21.1.0 with certain limitations, contact your AppDynamics account representative.

#### SaaS Controller version >=21.1.0

To view your current AppDynamics build version in the Controller UI, go to ![Settings](assets/img/appd-geariconblack-white.png) > **About AppDynamics**.

#### Active AppDynamics Pro Edition

To obtain your unique `X-APPD-KEY`, you should work closely with your AppDynamics account representative. To learn more, see X-APPD-KEY in the Description of Resource Attributes section.

### AppDynamics Credentials

#### Permissions

Users must have a role with the **View and Configure Licenses** permission for license management activity. To view your current AppDynamics edition in the Controller UI, go to ![Settings](assets/img/appd-geariconblack-white.png) > License.

## Configure the AWS OpenTelemetry Collector YAML File

To use AppDynamics to send distributed traces, you must configure the AWS OpenTelemetry Collector YAML file:

1. Verify that you have successfully installed the AWS Distro for OpenTelemetry Collector on your deployment.
2. Configure your applications to send service resource attributes.
3. Configure the AWS OTel Collector for AppDynamics:

  - `resource` and `batch processors`
  - `receivers`
  - `OTLPHTTP exporter`
  - `service`

4. Verify the configuration.

### Install the AWS Otel Collector

Install the AWS OTel Collector in your computing environment. The OTel Collector acts as the receiver in your pipeline and gathers telemetry data from various applications. See [Setting up AWS Distro for OpenTelemetry Collector in Amazon Elastic Computer Cloud](https://aws-otel.github.io/docs/setup/ec2).

### Configure Your Applications to Send Service Resource Attributes

AppDynamics relies on `service.name` and `service.namespace` trace resource attributes to map the services to AppDynamics tiers and applications respectively.

- `service.name`: your AppDynamics tier name. Set corresponding `service.name` trace resource attribute for every service being monitored.  
- `service.namespace`: your AppDynamics application name. Set corresponding `service.namespace` trace resource attribute for every service being monitored.
  - You can set these `service.name` and `service.namespace` attributes:
    1. Using `OTEL_RESOURCE_ATTRIBUTES` [environment variable](https://github.com/open-telemetry/opentelemetry-specification/blob/master/specification/resource/sdk.md#specifying-resource-information-via-an-environment-variable).
    2. Inside your application code: please consult the appropriate OpenTelemetry language-specific documentation for your code.

### Configure AWS OTel Collector for AppDynamics

By default, the AWS OTel Collector enables and accepts OTLP trace data and sends it to the AppDynamics backend using the default
configuration through the [OTLP HTTP Exporter](https://github.com/open-telemetry/opentelemetry-collector/tree/master/exporter/otlphttpexporter).

To configure your AppDynamics Controller to work with the AWS OTel Collector, edit your `otel-config.yml` configuration file using the following information:

#### Processors

##### Resource Processor

Use the [resource processor](https://github.com/open-telemetry/opentelemetry-collector/tree/master/processor/resourceprocessor) to add the AppDynamics Controller host, and port name.

- `appdynamics.controller.host`: your AppDynamics Controller host name.
- `appdynamics.controller.port`: your AppDynamics Controller port number.

```yml
processors:
  resource/appdynamics:
    attributes:
  - key: appdynamics.controller.host
    action: upsert
    value: "acme.saas.appdynamics.com"
  - key: appdynamics.controller.port
    action: upsert
    value: 443
```

##### Batch Processor

Use the [batch processor](https://github.com/open-telemetry/opentelemetry-collector/tree/master/processor/batchprocessor) to improve performance. The `batch` setting accumulates data received through the OpenTelemetry AWS Observability Collector pipeline and sends it to the backend efficiently. The 'batch' setting defaults the collection and processing to a timeout of 30 seconds, or when a batch size of 8192 is reached.

- `timeout`: Time duration after which a batch will be sent regardless of size. Default is 30 seconds.
- `send_batch_size`: Number of spans or metrics after which a batch will be sent. Default is 8192.

```yml
processors:
  batch:
    timeout: 30s
    send_batch_size: 8192
```

##### Receivers

Receivers use OTLP to support transaction-oriented application data processing. Specify your desired endpoints:

```yml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: localhost:55680
      http:
        endpoint: localhost:55681
```

##### Exporters

Use the OTLPHTTP Exporter to send data, including the X-APPD-KEY, to the AppDynamics endpoint.

```yml
exporters:
  otlphttp/appdynamics:
    endpoint: <appd endpoint>
    headers: {"x-appd-key": "<set to the API key you received>"}
```

##### Services

Ensure that all previously noted exporters, receivers, and processors are included in the service pipeline as shown:

```yml
service:
  pipelines:
    traces:
      receivers: [otlp]
      processor: [resource/appdynamics, batch/appdynamics]
      exporters: [otlphttp/appdynamics]
```

##### AppDynamics Configuration File Example

```yml
processors:
  resource:
    attributes:
    - key: appdynamics.controller.host
      action: upsert
      value: "acme.saas.appdynamics.com"
    - key: appdynamics.controller.port
      action: upsert
      value: 443
protocols:
      grpc:
      endpoint: localhost:55680
      http:
      endpoint: localhost:55681
exporters:
  otlphttp/appdynamics:
    endpoint: <appd endpoint>
    headers: {"x-appd-key": "<set to the API key you received>"}

service:
  pipelines:
    traces:
      receivers: [otlp]
      processor: [resource/appdynamics, batch/appdynamics]
      exporters: [otlphttp/appdynamics]
```

### Resources Attributes Description

You must configure four data types to send OpenTelemetry trace data to the AppDynamics backend. Two of the data types are OpenTelemetry resources, while the other two are common specification attributes.

AppDynamics uses standard attributes for the resources portion of an OpenTelemetry data packet. These attributes are used in the [Resource](https://github.com/open-telemetry/opentelemetry-specification/blob/master/specification/resource/sdk.md), and are inherited from the
[OpenTelemetry Resource Semantic Conventions]( https://github.com/open-telemetry/opentelemetry-specification/tree/master/specification/resource/semantic_conventions) standard.

Resources attributes are grouped logically by the concept type that they describe. Attributes in the same group have a common prefix that ends with a dot (.) .
For example, all attributes in a group that describe AppDynamics properties begin with `appdynamics.` .

AppDynamics attribute groups have a required column. If any attribute exists in the resource, then all attributes that are marked as required, must also exist.

| Location | Key | Type | Specification | Example | Required | Description |
|---|---|---|---|---|---|---|
| HTTP Header | `X-APPD-KEY` | string | attribute | `x-appd-key` | Yes | Your AppDynamics API key must be defined as an HTTP header. [1] |
| Resource Attribute | `appdynamics.controller.host` | string | attribute | `acme.saas.appdynamics.com` | Yes | AppDynamics Controller host used by your AWS Distro. Do not include http:// or https:// |
| Resource Attribute |`appdynamics.controller.port` | integer | attribute | `8080`| Yes | AppDynamics Controller port number. |
| Resource Attribute |`service.name` | string | resource | `Shop`| Yes | Logical name of the service; equivalent to your AppDynamics tier name. Set corresponding `service.name` trace resource attribute for every service being monitored either via SDK.  set the resource attributes. [2] |
| Resource Attribute |`service.namespace` | string | resource | `shoppingcart` | Yes | A namespace for the `service.name`; equivalent to your AppDynamics application name. Set corresponding `service.namespace` trace resource attribute for every service being monitored either via SDK. [3]

**[1]:** To obtain your unique `X-APPD-KEY`, you should work closely with your AppDynamics account representative.

**[2]:** MUST be the same for all instances of horizontally scaled services.

**[3]:** A non-null, non-empty string value for service.namespace is required.

## Verify Configuration

To validate that your configuration is working properly, review your collector logs.

## Visualize Your OpenTelemetry Data

Flow maps are a dynamic visual representation of your monitored environment's components and activities. Services monitored using OpenTelemetry are represented by the OpenTelemetry icon in the AppDynamics User Interface.

To view your OpenTelemetry data:

1. Select the OpenTelemetry-enabled Controller.
2. Navigate to the application name that you specified with the `service.namespace` resource attribute value.
3. Select Application Dashboard > Application Flow Map.

The following screenshot shows an application with OpenTelemetry enabled.

![OT Application Flow Map Screenshot]( images/aws-ot-java-flowmap.png)

See **The Cross-BT Hovercard in the Application Flow Map** section of the [Flow Maps](https://docs.appdynamics.com/display/PRO45/Flow+Maps) page to learn more.

## Troubleshooting

**Flow Map**
If you do not see the flow map in the Controller, review that you followed the configuration procedure correctly. If the issue persists, please work with your AppDynamics account representative to resolve the issue.
